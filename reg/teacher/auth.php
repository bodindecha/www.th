<?php session_start();$show_auth_form=false;$header_title="Teachers";$header_desc="Authorized teacher only";function check_perm($un){include("../resource/appwork/config.php");if(in_array($un,$perm["admin"]))$_SESSION['user_perm']=50;else $_SESSION['user_perm']=10;}function ldap_authen($server,$base_dn,$useraccount,$password){$ldapserver=ldap_connect($server);ldap_set_option($ldapserver,LDAP_OPT_PROTOCOL_VERSION,3);ldap_set_option($ldapserver,LDAP_OPT_TIMELIMIT,6);ldap_set_option($ldapserver,LDAP_OPT_REFERRALS,0);$useraccountad="BODIN\\".$useraccount;$bind=@ldap_bind($ldapserver,$useraccountad,$password);$authen="true";if(!$bind)$authen="false";$filter="samaccountname=".$useraccount;$result=@ldap_search($ldapserver,$base_dn,$filter);$info=@ldap_get_entries($ldapserver,$result);if(!$result)$authen="false";if($info["count"]==0)$authen="false";if($info["count"]>1)$authen="false";if(isset($info[0]["distinguishedName"]))$user_dn=$info[0]["distinguishedName"];else $user_dn="";$bind=@ldap_bind($ldapserver,$useraccountad,$password);if(!$bind)$authen="false";ldap_close($ldapserver);return $authen;}if(isset($_POST['zone']))$zone=$_POST['zone'];else $zone=0;if(isset($_POST['ac']))$_POST['ac']=strval($db->real_escape_string($_POST['ac']));if(isset($_POST['ac_name']))$_POST['ac_name']=strval($db->real_escape_string($_POST['ac_name']));if(isset($_SESSION['user_ac']))unset($_SESSION['user_ac']);if(isset($_POST['username'])&&isset($_POST['password'])){$_POST['username']=str_replace("*","",strtolower(trim($_POST['username'])));if($_POST['username']<>""&&$_POST['password']<>""){$authenzone[1][0]="ou=teacher,dc=bodin,dc=ac,dc=th";$authenzone[1][1]="ldap01.bodin.ac.th";$authenzone[1][2]="ldap02.bodin.ac.th";$authenzone[2][0]="ou=employee,dc=bodin,dc=ac,dc=th";$authenzone[2][1]="ldap01.bodin.ac.th";$authenzone[2][2]="ldap02.bodin.ac.th";$authen="false";$i=1;while($i<count($authenzone[$zone])){$authen=ldap_authen($authenzone[$zone][$i],$authenzone[$zone][0],$_POST['username'],$_POST['password']);if($authen=="true"){$i=count($authenzone[$zone]);$zonename=substr($authenzone[$zone][0],3,7);}else $i++;}if($authen=="true"){echo '{"success": true}';$_SESSION['user_ac']=true;check_perm($_POST['username']);}else{echo '{"success": false}';}}}else{echo '<!doctype html><html xmlns="http://www.w3.org/1999/xhtml"><head>';include("../resource/hpe/heading.php");include("../resource/hpe/init_ss.php");echo '<style type="text/css">main div.container{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:420px;height:100px;text-align:center;line-height:50px}main div.container button{padding:5px 15px;font-family:\'Sarabun\',serif;font-size:18.75px;line-height:30px;cursor:pointer}</style><script type="text/javascript">function fac(){app.ui.lightbox.close(),app.sys.auth.tac("'.(isset($_GET['return_url'])?$_GET['return_url']:"").'")}$(document).ready(function(){'.(isset($_GET['minda'])?'fac()':'app.sys.auth.teacher()').',$("html body header section div.head-item.auth").remove(),$.ajax({url:"/reg/resource/appwork/unauth.php?f=t"})});</script></head><body>';include("../resource/hpe/header.php");echo '<main shrink="'.(($_COOKIE['sui_open-nt'])??"false").'"><div class="container"><span>Please be authorized to continue.<br></span><button onClick="app.sys.auth.teacher()" class="blue">Authenticate</button></div></main>';include("../resource/hpe/material.php");echo '<footer>';include("../resource/hpe/footer.php");echo '</footer></body></html>';} ?>
