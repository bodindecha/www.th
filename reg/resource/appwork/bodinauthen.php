<?php session_start();$hrfr=isset($_SERVER['HTTP_REFERER'])?$_SERVER['HTTP_REFERER']:"";if(strpos($hrfr,$_SERVER['SERVER_NAME'])>-1&&isset($_SESSION['auth']))unset($_SESSION['auth']);include("db_connect.php");$apis=array("dc933a02"=>["TianTcl","42629.std.bodin.ac.th"]);foreach($apis as $kq=>$ud){if($_SERVER['HTTP_ORIGIN']=="https://".$ud[1]){header("Access-Control-Allow-Origin: ".$_SERVER['HTTP_ORIGIN']);break;}}function valid_api(){if(!isset($hrfr))$hrfr=isset($_SERVER['HTTP_REFERER'])?$_SERVER['HTTP_REFERER']:"";if(isset($_POST['api_key'])){$ak=str_rot13(substr(strrev(base64_decode(trim($_POST['api_key'])."=")),13,8));return(isset($apis[$ak])&&parse_url($hrfr)['host']==$apis[$ak][1]);}else return false;}function getuserdata($user,$zone){return[""];}$generations=[48=>39212,49=>40036,50=>40855,51=>41700,52=>42537,53=>43323];function getstdgen($stdid,$generations=$generations){$gen=0;for($g=48;$g<53;$g++){if($stdid>=$generations[$g])$gen=$g;else break;}return($gen)?["ou=bd".strval($gen).",","ou=bd".strval($gen-3).","]:"";}function ldap_authen($server,$base_dn,$useraccount,$password){$ldapserver=ldap_connect($server);ldap_set_option($ldapserver,LDAP_OPT_PROTOCOL_VERSION,3);ldap_set_option($ldapserver,LDAP_OPT_TIMELIMIT,6);ldap_set_option($ldapserver,LDAP_OPT_REFERRALS,0);$useraccountad="BODIN\\".$useraccount;$bind=@ldap_bind($ldapserver,$useraccountad,$password);$authen="true";if(!$bind)$authen="false";$filter="samaccountname=".$useraccount;$result=@ldap_search($ldapserver,$base_dn,$filter);$info=@ldap_get_entries($ldapserver,$result);if(!$result)$authen="false";if($info["count"]==0)$authen="false";if($info["count"]>1)$authen="false";if(isset($info[0]["distinguishedName"]))$user_dn=$info[0]["distinguishedName"];else $user_dn="";$bind=@ldap_bind($ldapserver,$useraccountad,$password);if(!$bind)$authen="false";ldap_close($ldapserver);return $authen;}if(isset($_POST['zone']))$zone=$_POST['zone'];else $zone=0;if($is_valid){if(isset($_POST['username'])&&isset($_POST['password'])){$_POST['username']=str_replace("*","",strtolower(trim($_POST['username'])));if($_POST['username']<>""&&$_POST['password']<>""){$bdstdgens=getstdgen(intval($_POST['username']));$bdstdgen=($bdstdgens=="")?"":$bdstdgens[0];$authenzone=array([$bdstdgen."ou=student,dc=bodin,dc=ac,dc=th","ldap01.bodin.ac.th","ldap02.bodin.ac.th"],["ou=teacher,dc=bodin,dc=ac,dc=th","ldap01.bodin.ac.th","ldap02.bodin.ac.th"],["ou=employee,dc=bodin,dc=ac,dc=th","ldap01.bodin.ac.th","ldap02.bodin.ac.th"],);$authen="false";$i=1;while($i<count($authenzone[$zone])){$authen=ldap_authen($authenzone[$zone][$i],$authenzone[$zone][0],$_POST['username'],$_POST['password']);if($authen=="true")$i=count($authenzone[$zone]);else $i++;}if($authen=="false"&&$zone==0&&$bdstdgens<>""){$bdstdgen=$bdstdgens[0];$authenzone[0][0]=$bdstdgen."ou=student,dc=bodin,dc=ac,dc=th";$i=1;while($i<count($authenzone[$zone])){$authen=ldap_authen($authenzone[$zone][$i],$authenzone[$zone][0],$_POST['username'],$_POST['password']);if($authen=="true")$i=count($authenzone[$zone]);else $i++;}}$_POST['username']=strval($db->real_escape_string($_POST['username']));$_POST['password']=strval($db->real_escape_string($_POST['password']));if($authen=="true"){if(strpos($hrfr,$_SERVER['SERVER_NAME'])>-1){$userdata=getuserdata($_POST['username'],$zone);if($userdata==false)echo '{"success": false, "reason": "Unable to get user\'s data."}';else if($userdata==null)echo '{"success": false, "reason": "No record of this user found."}';else{echo '{"success": true}';$_SESSION['auth']=array();}}else echo '{"success": true, "token": "'.sha1(time()).'"}';}else echo '{"success": false, "reason": [3, "Incorrect username or password."]}';}else echo '{"success": false, "reason": [3, "Parameter(s) empty."]}';}else if($hrfr=="")header("Location: https://bodin.ac.th");else echo '{"success": false, "reason": [3, "No parameters."]}';}else echo '{"success": false, "reason": [2, "Invalid API key."]}';$db->close(); ?>
